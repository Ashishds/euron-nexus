<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Interview Session - AI Recruiter</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#0A66C2',
                        'hover-blue': '#004182',
                        'bg-surface': '#F3F6F8',
                        'card-surface': '#FFFFFF',
                        'border-color': '#E5E7EB',
                        'primary-text': '#111827',
                        'secondary-text': '#6B7280',
                        'success': '#057642',
                        'warning': '#B45309',
                        'error': '#B91C1C',
                    },
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar {
            display: none;
        }

        body {
            font-family: 'Inter', sans-serif;
        }

        .typing-indicator span {
            animation: blink 1.4s infinite both;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes blink {

            0%,
            80%,
            100% {
                opacity: 0;
            }

            40% {
                opacity: 1;
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .resume-dropzone {
            border: 2px dashed #CBD5E1;
            transition: all 0.3s ease;
        }

        .resume-dropzone.dragover {
            border-color: #0A66C2;
            background: rgba(10, 102, 194, 0.05);
        }

        .resume-dropzone.uploaded {
            border-color: #057642;
            background: rgba(5, 118, 66, 0.05);
        }

        .skill-tag {
            display: inline-block;
            padding: 2px 8px;
            margin: 2px;
            border-radius: 9999px;
            font-size: 11px;
            font-weight: 500;
            background: rgba(10, 102, 194, 0.1);
            color: #0A66C2;
        }

        .agent-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
    </style>
</head>

<body class="font-inter antialiased bg-bg-surface min-h-screen">
    <!-- Header -->
    <header class="h-16 bg-card-surface border-b border-border-color flex items-center justify-between px-4 md:px-6">
        <div class="flex items-center space-x-4">
            <a href="/" class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-primary-blue rounded-lg flex items-center justify-center">
                    <i class="fa-solid fa-shield-halved text-white text-lg"></i>
                </div>
                <div>
                    <div class="text-primary-text text-lg font-bold leading-none">AI Recruiter</div>
                    <div class="text-xs text-secondary-text">AI Interview</div>
                </div>
            </a>
        </div>

        <div class="flex items-center space-x-4">
            <div class="hidden sm:flex items-center space-x-2 bg-green-100 px-4 py-2 rounded-full">
                <div class="w-2 h-2 bg-success rounded-full pulse"></div>
                <span class="text-sm text-success font-semibold">Interview Active</span>
            </div>
            <div id="timer"
                class="flex items-center space-x-2 bg-bg-surface px-4 py-2 rounded-lg border border-border-color">
                <i class="fa-solid fa-clock text-secondary-text"></i>
                <span class="text-sm font-semibold text-primary-text">25:00</span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex flex-col lg:flex-row h-[calc(100vh-64px)]">
        <!-- Left Panel - Video -->
        <div class="hidden lg:block w-1/3 bg-card-surface border-r border-border-color p-6">
            <div class="h-full flex flex-col">
                <h3 class="text-lg font-semibold text-primary-text mb-4">Video Feed</h3>

                <!-- Candidate Video -->
                <div class="relative bg-gray-900 rounded-xl overflow-hidden mb-4 flex-1 group">
                    <video id="localVideo" class="absolute inset-0 w-full h-full object-cover hidden" autoplay
                        playsinline muted></video>
                    <div id="cameraPlaceholder" class="absolute inset-0 flex items-center justify-center">
                        <div class="text-center cursor-pointer" onclick="startCamera()">
                            <div
                                class="w-24 h-24 bg-primary-blue rounded-full flex items-center justify-center mx-auto mb-4 group-hover:bg-hover-blue transition-colors">
                                <i class="fa-solid fa-camera text-white text-4xl"></i>
                            </div>
                            <p class="text-white text-sm">Click to Enable Camera</p>
                            <p class="text-gray-400 text-xs mt-1">Required for interview</p>
                        </div>
                    </div>
                    <div class="absolute bottom-3 left-3 right-3 flex items-center justify-between z-10">
                        <span class="bg-black/50 text-white text-xs px-2 py-1 rounded">You</span>
                        <div id="micStatus" class="hidden">
                            <i class="fa-solid fa-microphone text-white text-xs"></i>
                        </div>
                    </div>
                </div>

                <!-- AI Interviewer Video -->
                <div class="relative bg-gradient-to-br from-primary-blue to-hover-blue rounded-xl overflow-hidden h-40">
                    <div class="absolute inset-0 flex items-center justify-center">
                        <div class="w-20 h-20 bg-white/20 rounded-full flex items-center justify-center">
                            <i class="fa-solid fa-robot text-white text-3xl"></i>
                        </div>
                    </div>
                    <div class="absolute bottom-3 left-3 right-3 flex items-center justify-between">
                        <span class="bg-black/50 text-white text-xs px-2 py-1 rounded">AI Interviewer</span>
                        <div id="aiSpeakingIndicator" class="flex items-center space-x-1 hidden">
                            <div class="w-2 h-2 bg-success rounded-full pulse"></div>
                            <span class="text-white text-xs">Speaking</span>
                        </div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="flex items-center justify-center space-x-4 mt-6">
                    <button id="micBtn"
                        class="w-12 h-12 bg-success rounded-full flex items-center justify-center hover:bg-success/80 transition-colors">
                        <i class="fa-solid fa-microphone text-white text-xl"></i>
                    </button>
                    <button id="videoBtn"
                        class="w-12 h-12 bg-primary-blue rounded-full flex items-center justify-center hover:bg-hover-blue transition-colors">
                        <i class="fa-solid fa-video text-white text-xl"></i>
                    </button>
                    <button id="endBtn"
                        class="w-12 h-12 bg-error rounded-full flex items-center justify-center hover:bg-error/80 transition-colors">
                        <i class="fa-solid fa-phone-slash text-white text-xl"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Right Panel - Chat -->
        <div class="flex-1 flex flex-col">
            <!-- Chat Header -->
            <div
                class="h-auto md:h-16 bg-card-surface border-b border-border-color flex flex-col md:flex-row items-start md:items-center justify-between px-4 md:px-6 py-2 md:py-0 space-y-2 md:space-y-0">
                <div>
                    <h2 id="interviewTitle" class="text-lg font-semibold text-primary-text">AI Technical Interview</h2>
                    <p class="text-xs text-secondary-text">Round 1 - Technical Assessment</p>
                </div>
                <div class="flex items-center space-x-3">
                    <select id="roleSelector"
                        class="h-10 px-4 bg-bg-surface border border-border-color rounded-lg text-sm text-primary-text focus:outline-none focus:border-primary-blue cursor-pointer">
                        <option value="Senior Software Developer">Senior Software Developer</option>
                        <option value="Data Scientist">Data Scientist</option>
                        <option value="Product Manager">Product Manager</option>
                        <option value="DevOps Engineer">DevOps Engineer</option>
                        <option value="Frontend Developer">Frontend Developer</option>
                    </select>
                    <button id="startInterviewBtn"
                        class="h-10 px-4 bg-success text-white text-sm font-semibold rounded-lg hover:bg-success/80 transition-colors">
                        <i class="fa-solid fa-play mr-2"></i>Start Interview
                    </button>
                </div>
            </div>


            <!-- Resume Upload Panel -->
            <div id="resumePanel" class="p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border-b border-border-color">
                <div class="max-w-2xl mx-auto">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2">

                            <h4 class="text-sm font-semibold text-primary-text">Upload Resume</h4>
                        </div>
                        <button id="skipResumeBtn"
                            class="text-xs text-secondary-text hover:text-primary-blue underline">Skip</button>
                    </div>

                    <!-- Dropzone -->
                    <div id="resumeDropzone" class="resume-dropzone rounded-lg p-4 text-center cursor-pointer">
                        <input type="file" id="resumeFileInput" accept=".pdf,.docx,.doc" class="hidden">
                        <div id="dropzoneContent">
                            <i class="fa-solid fa-cloud-arrow-up text-secondary-text text-2xl mb-2"></i>
                            <p class="text-sm text-secondary-text">Drag & drop your resume or <span
                                    class="text-primary-blue font-medium">click to browse</span></p>
                            <p class="text-xs text-secondary-text mt-1">PDF or DOCX • Max 5MB</p>
                        </div>
                        <div id="uploadProgress" class="hidden">
                            <div class="flex items-center justify-center space-x-2">
                                <i class="fa-solid fa-spinner fa-spin text-primary-blue"></i>
                                <span id="uploadStatus"
                                    class="text-sm text-primary-blue font-medium">Uploading...</span>
                            </div>
                        </div>
                        <div id="uploadSuccess" class="hidden">
                            <div class="flex items-center justify-center space-x-2 mb-2">
                                <i class="fa-solid fa-check-circle text-success text-xl"></i>
                                <span class="text-sm text-success font-semibold">Resume Analyzed!</span>
                            </div>
                            <div id="skillTags" class="mt-2"></div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Evaluation Scorecard (shown after interview ends) -->
            <div id="evaluationPanel"
                class="hidden p-6 bg-gradient-to-r from-green-50 to-emerald-50 border-b border-border-color">
                <div class="max-w-2xl mx-auto">
                    <div class="text-center mb-4">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-success rounded-full mb-3">
                            <i class="fa-solid fa-clipboard-check text-white text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-primary-text">Interview Evaluation</h3>
                        <p id="recommendationBadge"
                            class="text-sm font-medium mt-2 px-4 py-1 rounded-full inline-block"></p>
                    </div>

                    <div class="bg-white rounded-xl p-4 border border-border-color mb-4">
                        <h4 class="text-sm font-semibold text-primary-text mb-3">Scorecard</h4>
                        <div id="scorecardGrid" class="grid grid-cols-2 gap-3"></div>
                    </div>

                    <div class="bg-white rounded-xl p-4 border border-border-color">
                        <h4 class="text-sm font-semibold text-primary-text mb-2">Summary</h4>
                        <p id="evaluationSummary" class="text-sm text-secondary-text"></p>
                    </div>
                </div>
            </div>

            <!-- Chat Messages -->
            <div id="chatMessages" class="flex-1 overflow-y-auto p-6 space-y-4">
                <!-- Messages will be added dynamically -->
            </div>

            <!-- Typing Indicator -->
            <div id="typingIndicator" class="hidden px-6 py-2">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-primary-blue rounded-full flex items-center justify-center">
                        <i class="fa-solid fa-robot text-white text-sm"></i>
                    </div>
                    <div class="bg-card-surface border border-border-color px-4 py-2 rounded-lg">
                        <div class="typing-indicator flex space-x-1">
                            <span class="w-2 h-2 bg-secondary-text rounded-full"></span>
                            <span class="w-2 h-2 bg-secondary-text rounded-full"></span>
                            <span class="w-2 h-2 bg-secondary-text rounded-full"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="bg-card-surface border-t border-border-color p-4">
                <div class="flex items-center space-x-3">
                    <button id="voiceRecordBtn"
                        class="w-10 h-10 bg-bg-surface border border-border-color rounded-full flex items-center justify-center text-secondary-text hover:text-primary-text hover:bg-gray-200 transition-colors">
                        <i class="fa-solid fa-microphone"></i>
                    </button>
                    <input type="text" id="messageInput"
                        class="flex-1 h-12 bg-bg-surface border border-border-color rounded-lg px-4 text-sm text-primary-text placeholder-secondary-text focus:outline-none focus:border-primary-blue focus:ring-2 focus:ring-primary-blue/10"
                        placeholder="Type your response or click the microphone to speak..." />
                    <button id="sendBtn"
                        class="h-12 px-6 bg-primary-blue text-white text-sm font-semibold rounded-lg hover:bg-hover-blue transition-colors flex items-center space-x-2">
                        <span>Send</span>
                        <i class="fa-solid fa-paper-plane text-xs"></i>
                    </button>
                </div>
                <div class="flex items-center justify-between mt-3">
                    <div class="flex items-center space-x-4 text-xs text-secondary-text">
                        <span><i class="fa-solid fa-brain mr-1"></i> Powered by ChatGPT</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button class="text-xs text-secondary-text hover:text-primary-blue">
                            <i class="fa-solid fa-flag mr-1"></i> Report Issue
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // STATE & CONFIG
        // ============================================================
        let conversationHistory = [];
        let timerSeconds = 25 * 60;
        let isInterviewComplete = false;
        let isInterviewStarted = false;
        let selectedRole = 'Senior Software Developer';

        // Resume State
        let resumeAnalysis = null;
        let resumeText = null;
        let interviewTranscript = '';

        // Browser STT & TTS State
        let recognition = null;
        let isListening = false;
        let isSpeaking = false;
        let synth = window.speechSynthesis;

        // ============================================================
        // DOM ELEMENTS
        // ============================================================
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const micBtn = document.getElementById('micBtn');
        const typingIndicator = document.getElementById('typingIndicator');
        const timerEl = document.getElementById('timer').querySelector('span');
        const aiSpeakingIndicator = document.getElementById('aiSpeakingIndicator');

        // Resume DOM
        const resumePanel = document.getElementById('resumePanel');
        const resumeDropzone = document.getElementById('resumeDropzone');
        const resumeFileInput = document.getElementById('resumeFileInput');
        const dropzoneContent = document.getElementById('dropzoneContent');
        const uploadProgress = document.getElementById('uploadProgress');
        const uploadSuccess = document.getElementById('uploadSuccess');
        const uploadStatus = document.getElementById('uploadStatus');
        const skillTags = document.getElementById('skillTags');

        // Evaluation DOM
        const evaluationPanel = document.getElementById('evaluationPanel');

        // Legacy/Other
        const voiceRecordBtn = document.getElementById('voiceRecordBtn');
        if (voiceRecordBtn) voiceRecordBtn.style.display = 'none'; // Ensure hidden

        // ============================================================
        // INITIALIZATION
        // ============================================================

        // Setup Speech Recognition
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                isListening = true;
                updateMicVisuals(true);
            };

            recognition.onend = () => {
                isListening = false;
                updateMicVisuals(false);
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                if (transcript.trim()) {
                    handleUserMessage(transcript);
                }
            };

            recognition.onerror = (event) => {
                console.error('STT Error:', event.error);
                isListening = false;
                updateMicVisuals(false);
            };
        } else {
            console.warn('Browser does not support SpeechRecognition');
            alert('Voice input not supported in this browser. Please use Chrome.');
        }

        // ============================================================
        // CORE INTERVIEW LOGIC
        // ============================================================

        async function startInterview() {
            if (isInterviewStarted) return;

            if (!resumeAnalysis && !confirm('Start without resume? The AI will not be able to ask specific questions about your background.')) {
                return;
            }

            isInterviewStarted = true;
            document.getElementById('startInterviewBtn').disabled = true;
            document.getElementById('startInterviewBtn').classList.add('opacity-50', 'cursor-not-allowed');
            document.getElementById('startInterviewBtn').innerHTML = '<i class="fa-solid fa-check mr-2"></i>In Progress';
            document.getElementById('roleSelector').disabled = true;

            addMessage('Connecting to AI Interviewer...', false, 'System');

            // Send initial request to get greeting
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [],
                        role: selectedRole,
                        resumeContext: resumeAnalysis
                    })
                });

                const data = await response.json();
                if (data.response) {
                    addMessage(data.response, false, 'Interviewer Agent');
                    conversationHistory.push({ role: 'assistant', content: data.response });
                    interviewTranscript += `AI: ${data.response}\n`;
                    speak(data.response);
                }
            } catch (err) {
                console.error('Start Error:', err);
                addMessage('Failed to start interview. Check console.', false, 'System');
            }
        }

        async function handleUserMessage(text) {
            if (!text.trim()) return;

            // 1. Show User Message
            addMessage(text, true);
            conversationHistory.push({ role: 'user', content: text });
            interviewTranscript += `User: ${text}\n`;
            messageInput.value = '';

            // 2. Show AI Typing
            showTyping(true);

            // 3. Get AI Response
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: conversationHistory,
                        role: selectedRole,
                        resumeContext: resumeAnalysis
                    })
                });

                const data = await response.json();
                showTyping(false);
                if (data.response) {
                    addMessage(data.response, false, 'Interviewer Agent');
                    conversationHistory.push({ role: 'assistant', content: data.response });
                    interviewTranscript += `AI: ${data.response}\n`;
                    speak(data.response);
                }
            } catch (err) {
                showTyping(false);
                console.error('Chat Error:', err);
                addMessage('Error communicating with server.', false, 'System');
            }
        }

        async function endInterview() {
            if (isInterviewComplete) return;
            if (!confirm('End the interview and generate evaluation?')) return;

            isInterviewComplete = true;
            if (isSpeaking) stopSpeaking();
            if (isListening) recognition.stop();

            messageInput.disabled = true;
            sendBtn.disabled = true;

            addMessage('⏳ Generating your evaluation scorecard...', false, 'System');

            try {
                const response = await fetch('/api/evaluate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        transcript: interviewTranscript,
                        role: selectedRole,
                        resumeAnalysis: resumeAnalysis
                    })
                });

                const data = await response.json();
                if (data.success && data.evaluation) {
                    displayEvaluation(data.evaluation);
                    addMessage('✅ Evaluation complete! Redirecting in 10 seconds...', false, 'System');
                    setTimeout(() => {
                        window.location.href = '/candidate';
                    }, 10000);
                } else {
                    addMessage('Failed to generate evaluation. See console.', false, 'System');
                }
            } catch (err) {
                console.error('Eval Error:', err);
                addMessage('Error generating evaluation.', false, 'System');
            }
        }

        // ============================================================
        // BROWSER TTS HELPER
        // ============================================================
        function speak(text) {
            if (synth.speaking) synth.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = 1.0;

            // Attempt to pick a decent voice
            const voices = synth.getVoices();
            const preferred = voices.find(v => v.name.includes('Google US English')) ||
                voices.find(v => v.name.includes('Samantha')) ||
                voices[0];
            if (preferred) utterance.voice = preferred;

            utterance.onstart = () => {
                isSpeaking = true;
                aiSpeakingIndicator.classList.remove('hidden');
                if (isListening) recognition.stop(); // Stop listening while AI speaks
            };

            utterance.onend = () => {
                isSpeaking = false;
                aiSpeakingIndicator.classList.add('hidden');

                // AUTO-RESTART MIC for continuous conversation
                if (isInterviewStarted && !isInterviewComplete) {
                    // Add a small delay to prevent picking up the tail end of TTS
                    setTimeout(() => {
                        try {
                            recognition.start();
                            console.log('Mic auto-restarted');
                        } catch (e) {
                            console.log('Mic already active or error', e);
                        }
                    }, 300);
                }
            };

            utterance.onerror = (e) => {
                console.error('TTS Error:', e);
                isSpeaking = false;
                aiSpeakingIndicator.classList.add('hidden');
            };

            synth.speak(utterance);
        }

        function stopSpeaking() {
            if (synth.speaking) synth.cancel();
            isSpeaking = false;
            aiSpeakingIndicator.classList.add('hidden');
        }

        // ============================================================
        // EVENT HANDLERS
        // ============================================================

        // Start Button
        document.getElementById('startInterviewBtn').addEventListener('click', startInterview);

        // End Button
        document.getElementById('endBtn').addEventListener('click', endInterview);

        // Role Selector
        document.getElementById('roleSelector').addEventListener('change', (e) => {
            selectedRole = e.target.value;
        });

        // Mic Toggle
        micBtn.addEventListener('click', () => {
            if (isListening) {
                recognition.stop();
            } else {
                if (isSpeaking) stopSpeaking();
                try { recognition.start(); } catch (e) { console.error(e); }
            }
        });

        // Send Button / Enter Key
        sendBtn.addEventListener('click', () => handleUserMessage(messageInput.value));
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleUserMessage(messageInput.value);
        });

        // Resume Dropzone
        resumeDropzone.addEventListener('click', () => {
            if (!uploadSuccess.classList.contains('hidden')) return;
            resumeFileInput.click();
        });
        resumeDropzone.addEventListener('dragover', (e) => { e.preventDefault(); resumeDropzone.classList.add('dragover'); });
        resumeDropzone.addEventListener('dragleave', () => resumeDropzone.classList.remove('dragover'));
        resumeDropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            resumeDropzone.classList.remove('dragover');
            if (e.dataTransfer.files[0]) handleResumeUpload(e.dataTransfer.files[0]);
        });
        resumeFileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) handleResumeUpload(e.target.files[0]);
        });
        document.getElementById('skipResumeBtn').addEventListener('click', () => resumePanel.classList.add('hidden'));

        async function handleResumeUpload(file) {
            const ext = file.name.split('.').pop().toLowerCase();
            if (!['pdf', 'docx', 'doc'].includes(ext)) return alert('PDF or DOCX only.');
            if (file.size > 5 * 1024 * 1024) return alert('Max 5MB.');

            dropzoneContent.classList.add('hidden');
            uploadProgress.classList.remove('hidden');
            uploadStatus.textContent = 'Uploading...';

            try {
                const formData = new FormData();
                formData.append('resume', file);
                const upRes = await fetch('/api/upload-resume', { method: 'POST', body: formData });
                if (!upRes.ok) throw new Error((await upRes.json()).error);

                const upData = await upRes.json();
                resumeText = upData.resumeText;
                uploadStatus.textContent = 'Analyzing...';

                const anRes = await fetch('/api/analyze-resume', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ resumeText })
                });
                if (!anRes.ok) throw new Error('Analysis failed');

                const anData = await anRes.json();
                resumeAnalysis = anData.analysis;

                uploadProgress.classList.add('hidden');
                uploadSuccess.classList.remove('hidden');
                resumeDropzone.classList.add('uploaded');

                if (resumeAnalysis.skills) {
                    skillTags.innerHTML = resumeAnalysis.skills.slice(0, 8)
                        .map(s => `<span class="skill-tag">${s}</span>`).join('');
                }
            } catch (err) {
                console.error(err);
                uploadProgress.classList.add('hidden');
                dropzoneContent.classList.remove('hidden');
                dropzoneContent.innerHTML = `<p class="text-error small">${err.message}</p>`;
            }
        }

        // Camera Preview
        document.getElementById('videoBtn').addEventListener('click', async () => {
            // Simple toggle logic or just start logic
            const videoEl = document.getElementById('localVideo');
            const placeholder = document.getElementById('cameraPlaceholder');
            if (!videoEl.classList.contains('hidden')) {
                // Stop
                const stream = videoEl.srcObject;
                if (stream) stream.getTracks().forEach(t => t.stop());
                videoEl.srcObject = null;
                videoEl.classList.add('hidden');
                placeholder.classList.remove('hidden');
            } else {
                // Start
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    videoEl.srcObject = stream;
                    videoEl.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                } catch (e) { alert('Camera access denied'); }
            }
        });

        // Timer
        function updateTimer() {
            const m = Math.floor(timerSeconds / 60).toString().padStart(2, '0');
            const s = (timerSeconds % 60).toString().padStart(2, '0');
            timerEl.textContent = `${m}:${s}`;
            if (timerSeconds > 0 && !isInterviewComplete) {
                timerSeconds--;
                setTimeout(updateTimer, 1000);
            }
        }
        updateTimer();

        // UI Helpers
        function addMessage(content, isUser = false, label = null) {
            const div = document.createElement('div');
            div.className = `flex items-start space-x-3 fade-in ${isUser ? 'flex-row-reverse space-x-reverse' : ''}`;
            div.innerHTML = `
                <div class="w-10 h-10 ${isUser ? 'bg-success' : 'bg-primary-blue'} rounded-full flex items-center justify-center flex-shrink-0">
                    <i class="fa-solid ${isUser ? 'fa-user' : 'fa-robot'} text-white"></i>
                </div>
                <div class="flex-1 ${isUser ? 'bg-primary-blue/10' : 'bg-card-surface border border-border-color'} p-4 rounded-lg max-w-xl">
                    ${label ? `<span class="text-xs font-semibold text-primary-blue mb-1 block">${label}</span>` : ''}
                    <p class="text-sm text-primary-text">${content}</p>
                </div>
            `;
            chatMessages.appendChild(div);
            // Auto scroll
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showTyping(show) {
            if (show) typingIndicator.classList.remove('hidden');
            else typingIndicator.classList.add('hidden');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function updateMicVisuals(isActive) {
            if (isActive) {
                micBtn.classList.add('pulse');
                micBtn.innerHTML = '<i class="fa-solid fa-stop text-white text-xl"></i>';
            } else {
                micBtn.classList.remove('pulse');
                micBtn.innerHTML = '<i class="fa-solid fa-microphone text-white text-xl"></i>';
            }
        }

        // Evaluator Display
        function displayEvaluation(evaluation) {
            evaluationPanel.classList.remove('hidden');
            const summaryEl = document.getElementById('evaluationSummary');
            if (summaryEl) summaryEl.textContent = evaluation.summary;

            const recBadge = document.getElementById('recommendationBadge');
            if (recBadge) {
                recBadge.textContent = evaluation.recommendation;
                recBadge.className = evaluation.recommendation.includes('Not')
                    ? 'text-sm font-medium mt-2 px-4 py-1 rounded-full inline-block bg-error/20 text-error'
                    : 'text-sm font-medium mt-2 px-4 py-1 rounded-full inline-block bg-success/20 text-success';
            }

            const grid = document.getElementById('scorecardGrid');
            if (grid && evaluation.scorecard) {
                grid.innerHTML = Object.entries(evaluation.scorecard).map(([k, v]) => `
                    <div class="flex justify-between items-center p-2 bg-bg-surface rounded border border-border-color">
                        <span class="capitalize text-sm font-medium">${k.replace(/_/g, ' ')}</span>
                        <div class="flex text-warning text-xs">
                             ${Array(5).fill(0).map((_, i) => `<i class="fa-solid fa-star ${i < v ? 'text-yellow-400' : 'text-gray-300'}"></i>`).join('')}
                        </div>
                    </div>
                `).join('');
            }
        }

        // ============================================================
        // CAMERA
        // ============================================================
        let cameraStream = null;

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                cameraStream = stream;
                const videoEl = document.getElementById('localVideo');
                videoEl.srcObject = stream;
                videoEl.classList.remove('hidden');
                document.getElementById('cameraPlaceholder').classList.add('hidden');
            } catch (err) {
                console.error('Camera fail:', err);
                alert('Could not access camera');
            }
        }

        // ============================================================
        // BUTTON EVENT LISTENERS
        // ============================================================

        // Mic toggle
        document.getElementById('micBtn').addEventListener('click', () => {
            if (isListening) {
                recognition.stop();
            } else {
                if (isSpeaking) stopSpeaking();
                try { recognition.start(); } catch (e) { console.error(e); }
            }
        });

        // Video toggle
        document.getElementById('videoBtn').addEventListener('click', function () {
            if (cameraStream) {
                const tracks = cameraStream.getVideoTracks();
                const isEnabled = tracks[0]?.enabled;
                tracks.forEach(t => t.enabled = !isEnabled);

                if (isEnabled) {
                    this.classList.remove('bg-primary-blue');
                    this.classList.add('bg-error');
                    this.innerHTML = '<i class="fa-solid fa-video-slash text-white text-xl"></i>';
                    document.getElementById('localVideo').classList.add('hidden');
                    document.getElementById('cameraPlaceholder').classList.remove('hidden');
                } else {
                    this.classList.remove('bg-error');
                    this.classList.add('bg-primary-blue');
                    this.innerHTML = '<i class="fa-solid fa-video text-white text-xl"></i>';
                    document.getElementById('localVideo').classList.remove('hidden');
                    document.getElementById('cameraPlaceholder').classList.add('hidden');
                }
            } else {
                startCamera();
            }
        });

        // End interview
        document.getElementById('endBtn').addEventListener('click', async function () {
            if (confirm('End this interview? You will receive an AI evaluation.')) {
                addMessage('⏳ Generating your evaluation scorecard...', false, 'Evaluator Agent');
                await endInterview();
                // Give user time to review the evaluation before redirecting
                addMessage('✅ Evaluation complete! Redirecting in 10 seconds...', false, 'System');
                setTimeout(() => {
                    window.location.href = '/candidate';
                }, 10000);
            }
        });

        // Legacy/Other
        const voiceRecordBtn2 = document.getElementById('voiceRecordBtn');
        if (voiceRecordBtn2) voiceRecordBtn2.style.display = 'none';

        // Role selector
        document.getElementById('roleSelector')?.addEventListener('change', function () {
            selectedRole = this.value;
        });
    </script>
</body>

</html>
